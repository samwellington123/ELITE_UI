<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Directum Supply Co. - Interactive Quote</title>
  <link rel="icon" type="image/png" href="images/red-favicon-logo.png">
  <style>
    :root{
      --bg: #FAFBFC;
      --surface: #FFFFFF;
      --text: #1A202C;         
      --muted: #4A5568;        
      --line: #E2E8F0;         
      --primary: #E53E3E;      /* Directum red */
      --primary-600: #C53030;  
      --primary-light: #FED7D7;
      --accent: #38A169;       /* Green for savings */
      --success: #38A169;      
      --danger: #E53E3E;       
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Inter',Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height: 1.6;
    }

    .wrap{max-width:1400px;margin:0 auto;padding:24px}

    /* Header */
    .header{
      margin-bottom:32px;
      border-bottom: 2px solid var(--line);
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .logo{
      height: 80px;
      width:auto;
      max-width: 200px;
      border-radius: 8px;
      object-fit: contain;
      transition: transform 0.3s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    .logo:hover{
      transform: scale(1.05);
    }
    
    .tools input:focus, #customerEmail:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
      outline: none;
    }
    .btn{
      height:44px;padding:0 20px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:var(--primary);font-weight:600;cursor:pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .btn:hover{
      border-color:var(--primary);
      background: var(--primary-light);
      transform: translateY(-1px);
    }
    /* Layout */
    .main{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:32px;
      align-items: start;
    }
    .panel{
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow: hidden;
    }

    /* Section headers */
    .section-header{
      padding:24px 24px 20px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(135deg, #FAFBFC 0%, #F7FAFC 100%);
    }
    .section-header h2{
      margin:0;font-size:18px;font-weight:700;letter-spacing:-0.3px;
      color: var(--text);
    }
    .section-header p{
      margin: 8px 0 0;
      font-size: 14px;
      color: var(--muted);
    }

    /* Products Grid */
    .products{
      padding:24px;
      display:grid;gap:24px;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
    }
    .product-card{
      border:1px solid var(--line);
      border-radius:var(--radius-sm);
      overflow:hidden;
      background:#fff;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .product-card:hover{
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
      border-color: rgba(229, 62, 62, 0.2);
    }

    .product-image{
      height:240px;
      background:#F8F9FA;
      border-bottom:1px solid var(--line);
      background-size:cover;
      background-repeat:no-repeat;
      background-position:center;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9CA3AF;
      font-size:14px;
      position: relative;
      overflow: hidden;
    }
    .product-image::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(229, 62, 62, 0.05), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .product-card:hover .product-image::after {
      opacity: 1;
    }

    .product-info{
      padding:20px;
    }
    .product-name{
      font-size:16px;
      font-weight:700;
      margin-bottom:6px;
      color: var(--text);
      line-height: 1.3;
    }
    .product-sku{
      font-size:12px;
      color:var(--muted);
      margin-bottom:12px;
      font-family: 'SF Mono', Monaco, monospace;
      background: #F7FAFC;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    .product-desc{
      font-size:14px;
      color:var(--muted);
      line-height:1.5;
      margin-bottom:16px;
    }

    /* Pricing Tiers */
    .pricing-tiers{
      background:#F8FAFC;
      border:1px solid var(--line);
      border-radius:10px;
      padding:12px;
      margin-bottom:16px;
    }
    .pricing-tier{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      padding:8px 12px;
      border-radius:8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .pricing-tier.active{
      background: linear-gradient(135deg, #FED7D7, #FEB2B2);
      color: #742A2A;
      font-weight: 600;
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(229, 62, 62, 0.2);
    }

    /* Quantity Controls */
    .quantity-controls{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .qty-btn{
      width:40px;
      height:40px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .qty-btn:hover{
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: scale(1.1);
    }
    .qty-input{
      width:80px;
      height:40px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:0 12px;
      text-align: center;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .qty-input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
      outline: none;
    }

    .product-price{
      font-size:16px;
      font-weight:800;
      color:var(--primary);
      margin-bottom:8px;
    }
    .savings-badge{
      display:inline-block;
      font-size:12px;
      color:var(--accent);
      background: #F0FFF4;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      margin-bottom:12px;
    }

    /* Quote Sidebar */
    .quote-sidebar{
      position:sticky;
      top:24px;
    }
    .quote-section{
      padding:20px;
      border-bottom:1px solid var(--line);
    }
    .quote-section:last-child{
      border-bottom:none;
    }

    .quote-items{
      max-height: 300px;
      overflow-y: auto;
    }
    .quote-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
      border:1px solid var(--line);
      border-radius:10px;
      margin-bottom:12px;
      background:#fff;
      transition: all 0.3s ease;
    }
    .quote-item:hover{
      transform: translateX(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .item-info{
      flex: 1;
    }
    .item-name{
      font-weight:600;
      font-size:14px;
      margin-bottom:4px;
    }
    .item-details{
      font-size:12px;
      color:var(--muted);
    }
    .remove-btn{
      padding: 6px 12px;
      border:1px solid #E53E3E;
      background:#fff;
      color:#E53E3E;
      border-radius:8px;
      cursor:pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .remove-btn:hover{
      background:#FED7D7;
      transform: scale(1.05);
    }

    .quote-totals{
      border-top:1px solid var(--line);
      padding-top:16px;
      margin-top:16px;
    }
    .total-line{
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin:8px 0;
      font-weight: 500;
    }
    .grand-total{
      font-weight:800;
      font-size:18px;
      color:var(--text);
      border-top:1px solid var(--line);
      padding-top:12px;
      margin-top:12px;
    }

    .quote-actions{
      margin-top:20px;
    }
    .primary-btn{
      width: 100%;
      height:48px;
      border:none;
      border-radius:12px;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .primary-btn::before{
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      transition: all 0.4s ease;
      transform: translate(-50%, -50%);
      border-radius: 50%;
    }
    .primary-btn:hover::before{
      width: 300px;
      height: 300px;
    }
    .primary-btn:hover{
      background: var(--primary-600);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(229, 62, 62, 0.3);
    }

    .help-text{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      margin-top:12px;
      text-align: center;
    }

    /* Status Messages */
    .message{
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      line-height: 1.5;
      font-weight: 500;
    }
    .message.success{
      background: #F0FFF4;
      color: #22543D;
      border: 1px solid #9AE6B4;
    }
    .message.error{
      background: #FED7D7;
      color: #742A2A;
      border: 1px solid #FEB2B2;
    }

    /* Empty States */
    .empty-state{
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-state h3{
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 600;
    }
    .empty-state p{
      margin: 0;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 1200px){
      .products{
        grid-template-columns:repeat(auto-fill, minmax(260px, 1fr));
      }
    }
    @media (max-width: 1024px){
      .main{
        grid-template-columns:1fr;
      }
      .quote-sidebar{
        position:static;
      }
    }
    @media (max-width: 768px){
      .products{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Promotional Banner -->
  <div style="background: linear-gradient(135deg, #E53E3E, #C53030); color: white; text-align: center; padding: 12px 0; font-size: 14px; font-weight: 600;">
    üî• Premium Custom Apparel with Fast Turnaround - Get Your Quote Today! 
    <a href="#" style="color: white; text-decoration: underline; margin-left: 12px; font-weight: 700;">Get Started</a>
  </div>

  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 0; text-align: left; padding-left: 40px;">
        <img src="images/red-long-logo.png" alt="Directum Supply Co." class="logo" id="brandLogo">
        <div style="display: flex; align-items: center; gap: 24px; font-size: 14px; color: var(--muted);">
          <div style="display: flex; align-items: center; gap: 8px;">
            üìû <span style="color: var(--primary); font-weight: 600;">Call Sales: 1-800-DIRECTUM</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            üí¨ <span style="color: var(--primary); font-weight: 600; cursor: pointer;">Chat with Expert</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            üìç <span>Serving Nationwide</span>
          </div>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-top: 1px solid var(--line);">
        <div style="display: flex; align-items: center; gap: 16px;">
          <input type="search" placeholder="Search products..." style="height: 40px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--line); width: 300px;"/>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <input id="customerEmail" type="email" placeholder="Enter email for branded mockups" style="height: 40px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--line);"/>
          <button class="btn" onclick="loadBrandedMockups()">Load Mockups</button>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button style="background: none; border: none; color: var(--text); font-size: 14px; font-weight: 600; cursor: pointer;">
              üë§ Sign In
            </button>
            <button style="background: none; border: none; color: var(--text); font-size: 18px; cursor: pointer; position: relative;">
              üõí
              <span style="position: absolute; top: -8px; right: -8px; background: var(--primary); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600;">0</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="message" style="display:none;"></div>

    <!-- Main Content -->
    <div class="main">
      <!-- Product Catalog -->
      <div class="panel">
        <div class="section-header">
          <h2>Product Catalog</h2>
          <p>Select quantities to build your custom quote</p>
        </div>
        <div id="productGrid" class="products"></div>
      </div>

      <!-- Quote Sidebar -->
      <div class="panel quote-sidebar">
        <div class="section-header">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <div>
              <h2>Your Quote</h2>
              <p>Live pricing updates as you select</p>
            </div>
            <button onclick="copyQuoteSummary()" style="background:none; border:1px solid var(--line); padding:8px; border-radius:6px; cursor:pointer; color:var(--muted); font-size:14px; display:flex; align-items:center; gap:4px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-subtle)'; this.style.color='var(--text)'" onmouseout="this.style.background='none'; this.style.color='var(--muted)'" title="Copy quote summary to clipboard">
              üìã Copy
            </button>
          </div>
        </div>
        
        <div class="quote-section">
          <div id="quoteItems" class="quote-items"></div>
        </div>

        <div class="quote-section">
          <label style="font-size:12px;color:var(--muted);margin-bottom:8px;display:block;font-weight:600;">ZIP Code (for tax estimate)</label>
          <input id="taxZip" type="text" placeholder="Enter ZIP code" style="width:100%;height:40px;padding:0 12px;border-radius:8px;border:1px solid var(--line);margin-top:8px;" oninput="calculateTax()"/>
        </div>
        
        <div class="quote-section">
          <div class="quote-actions">
            <button id="checkoutBtn" class="primary-btn" onclick="proceedToCheckout()">
              üöÄ Get Final Quote & Checkout
            </button>
            <div class="help-text">
              Stripe will collect shipping details and calculate final pricing
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let products = [];
    let quote = [];
    let taxAmount = 0;
    const ADMIN_BBOX_TOKEN = 'directum-bbox-setup';
    window.__bboxForcedMode = false;
    window.__bboxQueue = [];

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get('success')) showMessage('Payment completed successfully!', 'success');
      if (params.get('canceled')) showMessage('Payment was canceled.', 'error');
      // Preload customerEmail from URL so products auto-load branded previews
      const urlEmail = (params.get('customerEmail') || '').trim();
      if (urlEmail) {
        const emailEl = document.getElementById('customerEmail');
        if (emailEl) emailEl.value = urlEmail;
      }
      
      // Handle logo fallback with debugging
      const logo = document.getElementById('brandLogo');
      let logoFallbackAttempted = false;
      
      // Test if logo loads
      logo.onload = function() {
        console.log('‚úÖ Logo loaded successfully:', this.src);
      };
      
      logo.onerror = function() {
        // Prevent infinite loop
        if (logoFallbackAttempted) {
          console.log('‚ö†Ô∏è Fallback SVG also failed, removing error handler');
          this.onerror = null;
          return;
        }
        
        logoFallbackAttempted = true;
        console.log('‚ùå Logo failed to load:', this.src);
        console.log('üîç Check if file exists at: /public/images/red-long-logo.png');
        
        // Use a simpler fallback that won't fail
        this.style.display = 'none';
        const fallbackText = document.createElement('div');
        fallbackText.innerHTML = '<span style="color: #E53E3E; font-weight: 800; font-size: 18px;">Directum Supply Co.</span>';
        this.parentNode.insertBefore(fallbackText, this.nextSibling);
        
        console.log('üé® Using text fallback');
      };
      
      // Test logo path immediately
      const testImg = new Image();
      testImg.onload = () => console.log('‚úÖ Logo path test successful');
      testImg.onerror = () => console.log('‚ùå Logo path test failed - file may not exist at: public/images/red-long-logo.png');
      testImg.src = 'images/red-long-logo.png';
      
      // Track quote from URL once; stop global version mode
      window.__quoteId = (params.get('quoteId') || '').trim();
      window.__versionId = '';

      // If a quote is present, try to load versions list
      if (window.__quoteId && urlEmail) {
        try { await loadVersions(urlEmail); } catch (e) { console.warn('versions load failed', e); }
      }
      
      await loadProducts();
      updateQuoteDisplay();

      // Secret forced BBox wizard
      const token = (params.get('bboxToken') || params.get('bbox') || '').trim();
      if (token && token === ADMIN_BBOX_TOKEN) {
        window.__bboxForcedMode = true;
        const missing = (products || []).filter(p => !Array.isArray(p.boxes) || p.boxes.length === 0);
        window.__bboxQueue = missing.map(p => p.id);
        if (window.__bboxQueue.length === 0) {
          showMessage('All products already have positions.', 'success');
        } else {
          showMessage(`BBox setup: ${window.__bboxQueue.length} products need positions`, 'success');
          startForcedBBoxWizard();
        }
      }
    });

    async function loadVersions(email) {
      if (!window.__quoteId || !email) { window.__versions = []; return; }
      try {
        const data = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/versions?email=${encodeURIComponent(email)}`).then(r => r.json());
        window.__versions = Array.isArray(data?.versions) ? data.versions : [];
      } catch (e) {
        console.warn('loadVersions failed', e);
        window.__versions = [];
      }
    }

    function startForcedBBoxWizard() {
      const next = window.__bboxQueue.shift();
      if (!next) { showMessage('‚úÖ BBox setup complete', 'success'); return; }
      openBBoxModal(next, { forced: true, onDone: () => setTimeout(startForcedBBoxWizard, 300) });
    }

    // Messages
    function showMessage(text, type = 'success') {
      const el = document.getElementById('statusMessage');
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    // Load products
    async function loadProducts() {
      try {
        console.log('Loading products...');
        const email = (document.getElementById('customerEmail')?.value || '').trim();
        const params = new URLSearchParams();
        if (email) params.set('customerEmail', email);
        if (window.__quoteId) params.set('quoteId', window.__quoteId);
        const url = params.toString() ? `/api/products?${params.toString()}` : '/api/products';
        
        console.log('Fetching from:', url);
        const resp = await fetch(url, { cache: 'no-store' });
        console.log('Response status:', resp.status);
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        
        const payload = await resp.json();
        console.log('Received payload:', payload);

        // Accept either an array or an object with a products array
        products = Array.isArray(payload) ? payload : (payload?.products || []);
        if (!Array.isArray(products)) products = [];
        
        console.log('Processed products:', products.length);
        renderProducts(products);
        showMessage(`Loaded ${products.length} products`, 'success');
        
      } catch (err) {
        console.error('loadProducts error:', err);
        products = [];
        renderProducts([]);
        showMessage('Could not load products: ' + err.message, 'error');
      }
    }

    // Render products
    function renderProducts(products) {
      const container = document.getElementById('productGrid');
      if (!container) return;

      if (!products || products.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No products available</h3>
            <p>Please check back later</p>
          </div>
        `;
        return;
      }

      const BLANK_IMAGE = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><rect width="800" height="800" fill="%23F7FAFC"/></svg>';
      const html = products.map(product => {
        const imageUrl = product.previewImageUrl || product.baseImageUrl || '';
        const basePrice = product.currentPrice || (product.pricing && product.pricing[0] ? product.pricing[0].price : 0);
        
        // Generate pricing tiers HTML
        const pricingTiersHtml = product.pricing ? product.pricing.map(tier => {
          const range = tier.maxQty ? `${tier.minQty}-${tier.maxQty}` : `${tier.minQty}+`;
          return `
            <div class="pricing-tier" data-range="${range}">
              <span>${range}</span>
              <span>$${Number(tier.price || 0).toFixed(2)}</span>
            </div>
          `;
        }).join('') : '';
        
        return `
          <div class="product-card" data-product-id="${product.id}">
            <div class="product-image" style="background-image:url('${imageUrl}');">
              ${!imageUrl ? 'No Image Available' : ''}
            </div>
            <div class="product-info">
              <div class="product-name">${product.name || ''}</div>
              <div class="product-sku">${product.sku || ''}</div>
              <div class="product-desc">${product.description || ''}</div>
              
              <div class="design-version-row" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                <label style="font-size:12px;color:var(--muted);">Design Version</label>
                <select class="design-select" data-id="${product.id}" style="padding:6px 8px;border:1px solid var(--line);border-radius:8px;">
                  <option value="">Default</option>
                </select>
                <span class="version-chip" data-id="${product.id}" style="margin-left:6px;font-size:11px;color:#742A2A;background:#FED7D7;border:1px solid #FEB2B2;padding:2px 8px;border-radius:999px;">Default</span>
              </div>
              
              ${pricingTiersHtml ? `
                <div class="pricing-tiers">
                  ${pricingTiersHtml}
                </div>
              ` : ''}
              
              <div class="quantity-controls">
                <button class="qty-btn" onclick="adjustQuantity('${product.id}', -1)">‚àí</button>
               <input id="qty-${product.id}" class="qty-input" type="number" value="0" min="0" onchange="updateProductPricing('${product.id}')" oninput="updateProductPricing('${product.id}')">
                <button class="qty-btn" onclick="adjustQuantity('${product.id}', 1)">+</button>
              </div>
              
              <div id="price-${product.id}" class="product-price">Starting at $${basePrice.toFixed(2)}</div>
              <div id="savings-${product.id}" class="savings-badge" style="display:none;"></div>
              
              <button class="btn" style="width: 100%; margin-top: 12px; background: var(--primary); color: white; border-color: var(--primary);" onclick="generateMockup('${product.id}', this)">
                üé® Generate Mockup
              </button>
              
              <button class="btn" style="width: 100%; margin-top: 8px; background: var(--accent); color: white; border-color: var(--accent);" onclick="openBBoxModal('${product.id}')">
                üìê Set Logo Position
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
      
      // Helpers for version chips + persistence
      function loadSavedVersions(){
        try { return JSON.parse(localStorage.getItem('versionSelections') || '{}'); } catch { return {}; }
      }
      function saveSelectedVersion(productId, version){
        const map = loadSavedVersions();
        if (version) map[productId] = version; else delete map[productId];
        localStorage.setItem('versionSelections', JSON.stringify(map));
      }
      function setVersionChip(productId, version){
        const chip = container.querySelector(`.version-chip[data-id="${productId}"]`);
        if (!chip) return;
        if (version) { chip.textContent = version; chip.style.display = 'inline-block'; }
        else { chip.textContent = 'Default'; chip.style.display = 'inline-block'; }
      }

      // Helper: cache and fetch legacy preview URLs (email-only, no version)
      async function getLegacyPreviewUrl(email, productId) {
        if (!email) return '';
        try {
          if (!window.__legacyProductsById) {
            const list = await fetch(`/api/products?customerEmail=${encodeURIComponent(email)}`, { cache: 'no-store' }).then(r => r.json());
            const map = {};
            (Array.isArray(list) ? list : []).forEach(p => { map[p.id] = (p.previewImageUrl || p.baseImageUrl || ''); });
            window.__legacyProductsById = map;
          }
          return window.__legacyProductsById[productId] || '';
        } catch (_) { return ''; }
      }
      
      // Rebuild a product's versions dropdown and select a version (no duplicates)
      window.repopulateVersionDropdown = async function(product, email, selectedVersion) {
        if (!window.__quoteId) return;
        const sel = container.querySelector(`.design-select[data-id="${product.id}"]`);
        const card = container.querySelector(`.product-card[data-product-id="${product.id}"]`);
        const imageDiv = card?.querySelector('.product-image');
        if (!sel) return;
        try {
          const data = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/products/${encodeURIComponent(product.id)}/versions?email=${encodeURIComponent(email)}`).then(r => r.json());
          const versionsRaw = Array.isArray(data?.versions) ? data.versions : [];
          const versions = Array.from(new Set(versionsRaw));
          const newSel = sel.cloneNode(true);
          newSel.innerHTML = '<option value="">Default</option>' + versions.map(v => `<option value="${v}">${v}</option>`).join('');
          sel.parentNode.replaceChild(newSel, sel);
          const targetVersion = selectedVersion && versions.includes(selectedVersion) ? selectedVersion : '';
          newSel.value = targetVersion;
          setVersionChip(product.id, targetVersion);
          // Load corresponding image
          if (targetVersion) {
            try {
              const j = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/versions/${encodeURIComponent(targetVersion)}/previews/${encodeURIComponent(product.id)}?email=${encodeURIComponent(email)}`).then(r => r.json());
              if (j?.url && imageDiv) imageDiv.style.backgroundImage = `url('${j.url}')`;
            } catch (_) {}
          } else {
            try {
              const list = await fetch(`/api/products?customerEmail=${encodeURIComponent(email)}`).then(r => r.json());
              const p = Array.isArray(list) ? list.find(x => x.id === product.id) : null;
              if (p?.previewImageUrl) imageDiv.style.backgroundImage = `url('${p.previewImageUrl}')`;
              else if (p?.baseImageUrl) imageDiv.style.backgroundImage = `url('${p.baseImageUrl}')`;
            } catch (_) {}
          }
          // Rebind change handler
          newSel.addEventListener('change', async (e) => {
            const version = e.target.value || '';
            if (version) {
              try {
                const j = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/versions/${encodeURIComponent(version)}/previews/${encodeURIComponent(product.id)}?email=${encodeURIComponent(email)}`).then(r => r.json());
                if (j?.url && imageDiv) imageDiv.style.backgroundImage = `url('${j.url}')`;
              } catch (err) { console.warn('version preview failed', err); }
            } else {
              try {
                const list = await fetch(`/api/products?customerEmail=${encodeURIComponent(email)}`).then(r => r.json());
                const p = Array.isArray(list) ? list.find(x => x.id === product.id) : null;
                if (p?.previewImageUrl) imageDiv.style.backgroundImage = `url('${p.previewImageUrl}')`;
                else if (p?.baseImageUrl) imageDiv.style.backgroundImage = `url('${p.baseImageUrl}')`;
              } catch (err) {}
            }
            saveSelectedVersion(product.id, version);
            setVersionChip(product.id, version);
          });
        } catch (err) { console.warn('repopulate versions failed', err); }
      }

      // Handle image fallback with robust chain: preview -> legacy -> base -> blank
      setTimeout(() => {
        products.forEach(product => {
            const productCard = container.querySelector(`[data-product-id="${product.id}"]`);
            const imageDiv = productCard?.querySelector('.product-image');
          if (!imageDiv) return;
          (async () => {
            const email = (document.getElementById('customerEmail')?.value || '').trim();
            const candidates = [];
            if (product.previewImageUrl) candidates.push(product.previewImageUrl);
            if (email) {
              try { const legacy = await getLegacyPreviewUrl(email, product.id); if (legacy) candidates.push(legacy); } catch (_) {}
            }
            if (product.baseImageUrl) candidates.push(product.baseImageUrl);
            candidates.push(BLANK_IMAGE);
            for (const url of candidates) {
              const ok = await new Promise(res => { const t = new Image(); t.onload = () => res(true); t.onerror = () => res(false); t.src = url; });
              if (ok) { imageDiv.style.backgroundImage = `url('${url}')`; return; }
            }
          })();
        });
      }, 100);

      // Periodically refresh presigned version URLs for selected versions
      function refreshVersionPreviews() {
        const email2 = (document.getElementById('customerEmail')?.value || '').trim();
        if (!email2 || !window.__quoteId) return;
        products.forEach(async (product) => {
          const sel = container.querySelector(`.design-select[data-id="${product.id}"]`);
          if (!sel) return;
          const version = sel.value || '';
          if (!version) return;
          try {
            const j = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/versions/${encodeURIComponent(version)}/previews/${encodeURIComponent(product.id)}?email=${encodeURIComponent(email2)}`, { cache: 'no-store' }).then(r => r.json());
            if (j?.url) {
              const card = container.querySelector(`.product-card[data-product-id="${product.id}"]`);
              const imageDiv = card?.querySelector('.product-image');
              if (imageDiv) imageDiv.style.backgroundImage = `url('${j.url}')`;
            }
          } catch (_) { /* ignore */ }
        });
      }
      if (!window.__versionRefreshTimer) {
        window.__versionRefreshTimer = setInterval(refreshVersionPreviews, 4 * 60 * 1000);
        document.addEventListener('visibilitychange', () => { if (!document.hidden) setTimeout(refreshVersionPreviews, 500); });
      }

      // If in version mode and a product lacks preview, seed it with legacy preview proactively
      (async () => {
        const email = (document.getElementById('customerEmail')?.value || '').trim();
        if (!email || !window.__quoteId || !window.__versionId) return;
        for (const product of products) {
          if (!product.previewImageUrl) {
            const productCard = container.querySelector(`[data-product-id="${product.id}"]`);
            const imageDiv = productCard?.querySelector('.product-image');
            if (!imageDiv) continue;
            const legacy = await getLegacyPreviewUrl(email, product.id);
            if (legacy) imageDiv.style.backgroundImage = `url('${legacy}')`;
          }
        }
      })();

      // Populate per-product version dropdowns
      const email = (document.getElementById('customerEmail')?.value || '').trim();
      const savedVersions = loadSavedVersions();
      if (email) {
        products.forEach(async (product) => {
          try {
            const sel = container.querySelector(`.design-select[data-id="${product.id}"]`);
            if (!sel) return;
            if (!window.__quoteId) return; // only meaningful with a quoteId
            const data = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/products/${encodeURIComponent(product.id)}/versions?email=${encodeURIComponent(email)}`).then(r => r.json());
            const versions = Array.isArray(data?.versions) ? data.versions : [];
            sel.innerHTML = '<option value="">Default</option>' + versions.map(v => `<option value="${v}">${v}</option>`).join('');
            // Apply saved selection if present
            const saved = savedVersions[product.id] || '';
            if (saved && versions.includes(saved)) {
              sel.value = saved;
              setVersionChip(product.id, saved);
              try {
                const j = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/versions/${encodeURIComponent(saved)}/previews/${encodeURIComponent(product.id)}?email=${encodeURIComponent(email)}`).then(r => r.json());
                const card = container.querySelector(`.product-card[data-product-id="${product.id}"]`);
                const imageDiv = card?.querySelector('.product-image');
                if (j?.url && imageDiv) imageDiv.style.backgroundImage = `url('${j.url}')`;
              } catch (err) {}
            } else {
              setVersionChip(product.id, '');
            }

            sel.addEventListener('change', async (e) => {
              const version = e.target.value || '';
              const card = container.querySelector(`.product-card[data-product-id="${product.id}"]`);
              const imageDiv = card?.querySelector('.product-image');
              if (!imageDiv) return;
              if (version) {
                try {
                  const j = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/versions/${encodeURIComponent(version)}/previews/${encodeURIComponent(product.id)}?email=${encodeURIComponent(email)}`).then(r => r.json());
                  if (j?.url) imageDiv.style.backgroundImage = `url('${j.url}')`;
                } catch (err) { console.warn('version preview failed', err); }
              } else {
                // Default legacy
                try {
                  const list = await fetch(`/api/products?customerEmail=${encodeURIComponent(email)}`).then(r => r.json());
                  const p = Array.isArray(list) ? list.find(x => x.id === product.id) : null;
                  if (p?.previewImageUrl) imageDiv.style.backgroundImage = `url('${p.previewImageUrl}')`;
                  else if (p?.baseImageUrl) imageDiv.style.backgroundImage = `url('${p.baseImageUrl}')`;
                } catch (err) {}
              }
              saveSelectedVersion(product.id, version);
              setVersionChip(product.id, version);
            });
          } catch (err) { console.warn('populate versions failed', err); }
        });
      }
    }

    // Load branded mockups
    function loadBrandedMockups() {
      console.log('Loading branded mockups...');
      showMessage('Loading products with branded mockups...', 'success');
      loadProducts();
    }

    // Open BBox Modal for positioning
    async function getExistingLogoUrl(email) {
      try {
        const resp = await fetch(`/api/customer/${encodeURIComponent(email)}/logo`);
        const j = await resp.json();
        if (j?.hasLogo && j.logoUrl) return j.logoUrl;
      } catch (e) { console.warn('logo lookup failed', e); }
      return '';
    }

    function openBBoxModal(productId, opts) {
      const forced = !!(opts && opts.forced);
      const onDone = (opts && typeof opts.onDone === 'function') ? opts.onDone : null;
      const product = products.find(p => p.id === productId);
      if (!product) {
        showMessage('Product not found', 'error');
        return;
      }
      
      // Create modal if it doesn't exist
      let modal = document.getElementById('bboxModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'bboxModal';
        modal.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:linear-gradient(180deg,#fff,#FAFBFC); border-radius:16px; padding:18px; max-width:92vw; max-height:92vh; box-shadow:0 16px 48px rgba(0,0,0,.18);">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
              <strong id="bboxTitle" style="font-size:16px;">Set Logo Position</strong>
              <span style="flex:1"></span>
              <input id="logoFile" type="file" accept="image/*" style="display:none;">
              <label for="logoFile" id="logoFileBtn" style="background:#fff;border:1px solid #e2e8f0;color:#1A202C;padding:8px 14px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;">‚¨ÜÔ∏è Upload Logo</label>
              <span id="logoFileName" style="font-size:12px;color:#4A5568;"></span>
              <input id="bboxVersionName" type="text" placeholder="Version name (e.g., V1)" style="padding:6px 8px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;min-width:140px;">
              <button id="bboxGrid" style="background:#fff;border:1px solid #e2e8f0;padding:8px 12px;border-radius:10px;cursor:pointer;">Grid: On</button>
              <button id="bboxApply" style="background:#38A169;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;">Apply Changes</button>
              <button id="bboxSave"  style="background:#111;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;">Save</button>
              <button id="bboxClear" style="background:#eee;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;">Clear</button>
              <button id="bboxClose" style="border:none;background:#eee;padding:8px 12px;border-radius:10px;cursor:pointer;">Close</button>
            </div>
            <div id="bboxCanvasWrap" style="position:relative; overflow:auto; border:1px solid #eee; border-radius:12px; background: repeating-conic-gradient(#f7fafc 0% 25%, transparent 0% 50%) 50% / 20px 20px;">
              <img id="bboxImg" src="" alt="product" style="max-width:85vw; max-height:70vh; display:block;">
              <canvas id="bboxCanvas" style="position:absolute; left:0; top:0;"></canvas>
            </div>
          </div>`;
        document.body.appendChild(modal);
      }
      
      const imgEl = document.getElementById('bboxImg');
      const canvas = document.getElementById('bboxCanvas');
      const wrap = document.getElementById('bboxCanvasWrap');
      let overlayImg = document.getElementById('bboxLogoOverlay');
      if (!overlayImg) {
        overlayImg = document.createElement('img');
        overlayImg.id = 'bboxLogoOverlay';
        overlayImg.style.position = 'absolute';
        overlayImg.style.left = '0';
        overlayImg.style.top = '0';
        overlayImg.style.pointerEvents = 'none';
        overlayImg.style.display = 'none';
        overlayImg.style.objectFit = 'contain';
        wrap.appendChild(overlayImg);
      }
      const title = document.getElementById('bboxTitle');
      const versionInput = document.getElementById('bboxVersionName');
      
      title.textContent = `Set Logo Position ‚Äî ${product.name}`;
      if (versionInput) {
        versionInput.value = (window.__versionId || 'V1');
        setTimeout(() => { try { versionInput.focus(); versionInput.select(); } catch(_){} }, 60);
        versionInput.addEventListener('input', () => { versionInput.style.borderColor = '#e2e8f0'; });
      }
      // Always start from a blank product image with no overlay/logo
      imgEl.src = product.baseImageUrl;
      if (overlayImg) { overlayImg.style.display = 'none'; overlayImg.src = ''; }
      const fileInputInit = document.getElementById('logoFile');
      if (fileInputInit) { try { fileInputInit.value = ''; } catch(_) {} }
      
      let start = null;
      let rect = null;
      // Ensure a clean state
      rect = null;
      
      function resizeCanvas() {
        canvas.width  = imgEl.clientWidth;
        canvas.height = imgEl.clientHeight;
        canvas.style.width  = imgEl.clientWidth + 'px';
        canvas.style.height = imgEl.clientHeight + 'px';
        draw();
      }
      
      function draw() {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if (!rect) return;
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#e53e3e';
        ctx.setLineDash([6,4]);
        const {x,y,w,h} = rect;
        ctx.strokeRect(x,y,w,h);
        // Live inches overlay if zones are available
        if (imgEl && window.__currentZonePxPerIn && w && h) {
          const w_in = Math.abs(w) * (imgEl.naturalWidth / imgEl.clientWidth) / window.__currentZonePxPerIn;
          const h_in = Math.abs(h) * (imgEl.naturalHeight / imgEl.clientHeight) / window.__currentZonePxPerIn;
          const label = `${w_in.toFixed(2)} in √ó ${h_in.toFixed(2)} in`;
          ctx.setLineDash([]);
          ctx.fillStyle = 'rgba(0,0,0,0.7)';
          ctx.strokeStyle = 'rgba(255,255,255,0.9)';
          ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
          const tw = ctx.measureText(label).width + 10;
          const tx = Math.min(canvas.width - tw - 6, Math.max(6, x));
          const ty = Math.max(18, y - 6);
          ctx.fillRect(tx, ty - 14, tw, 18);
          ctx.fillStyle = '#fff';
          ctx.fillText(label, tx + 5, ty);
        }
      }
      
      function toNaturalCoords(r) {
        const scaleX = imgEl.naturalWidth  / imgEl.clientWidth;
        const scaleY = imgEl.naturalHeight / imgEl.clientHeight;
        const x1 = Math.round(r.x * scaleX);
        const y1 = Math.round(r.y * scaleY);
        const x2 = Math.round((r.x + r.w) * scaleX);
        const y2 = Math.round((r.y + r.h) * scaleY);
        return { x1, y1, x2, y2 };
      }
      
      function onDown(ev) {
        const b = canvas.getBoundingClientRect();
        start = { x: ev.clientX - b.left, y: ev.clientY - b.top };
        rect = { x:start.x, y:start.y, w:0, h:0 };
        draw();
      }
      function onMove(ev) {
        if (!start) return;
        const b = canvas.getBoundingClientRect();
        const x = ev.clientX - b.left, y = ev.clientY - b.top;
        rect.w = x - rect.x; rect.h = y - rect.y;
        draw();
      }
      function onUp() { start = null; }
      
      function clearBox() { rect = null; if (overlayImg) { overlayImg.style.display = 'none'; } draw(); }
      
      async function applyChanges(autoSaveVersionName) {
        if (!rect) { 
          showMessage('Draw a box first by clicking and dragging on the image', 'error'); 
          return; 
        }
        const n = toNaturalCoords({
          x: Math.min(rect.x, rect.x+rect.w),
          y: Math.min(rect.y, rect.y+rect.h),
          w: Math.abs(rect.w),
          h: Math.abs(rect.h)
        });
        // Validate against zones physical bounds if available
        if (window.__currentZoneSpec && window.__currentZonePxPerIn) {
          const w_in = (n.x2 - n.x1) / window.__currentZonePxPerIn;
          const h_in = (n.y2 - n.y1) / window.__currentZonePxPerIn;
          const pw = Number(window.__currentZoneSpec?.physical?.w_in || 0);
          const ph = Number(window.__currentZoneSpec?.physical?.h_in || 0);
          if (pw && ph && (w_in > pw + 1e-6 || h_in > ph + 1e-6)) {
            showMessage(`Art too large for zone. Max ${pw.toFixed(2)}√ó${ph.toFixed(2)} in, got ${w_in.toFixed(2)}√ó${h_in.toFixed(2)} in.`, 'error');
            return;
          }
        }
        const email = (document.getElementById('customerEmail')?.value || '').trim();

        // Airtable removed; bbox saving handled via Neon-backed endpoints
        let saved = false;
        try {
          const resp = await fetch(`/api/products/${encodeURIComponent(product.id)}/boxes`, {
            method: 'POST', headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ boxes: [{ name: 'print_area', x1:n.x1, y1:n.y1, x2:n.x2, y2:n.y2 }] })
          });
          const j = await resp.json().catch(() => ({}));
          if (resp.ok && j?.ok) saved = true;
        } catch (e) { console.warn('bbox save warning', e); }

        // Resolve logo: use uploaded file if provided, else existing S3 logo
        let logoUrl = '';
        const fileInput = document.getElementById('logoFile');
        const file = fileInput && fileInput.files && fileInput.files[0];
        if (file) {
          try {
            // Use server-side upload to avoid S3 CORS
            const form = new FormData();
            form.append('email', email);
            form.append('logo', file, file.name);
            const up = await fetch('/api/logo/upload', { method: 'POST', body: form }).then(r => r.json());
            if (!up?.ok) throw new Error(up?.error || 'Logo upload failed');
            logoUrl = up.url;
          } catch (e) {
            console.warn('logo upload failed, fallback to existing', e);
            logoUrl = await getExistingLogoUrl(email);
          }
        } else {
          logoUrl = await getExistingLogoUrl(email);
        }

        if (!logoUrl) { showMessage('No logo found. Upload a logo under /logo/ and retry.', 'error'); return; }

        // Auto-run fast preview in modal without persisting
        if (!autoSaveVersionName) {
          try {
            // Position overlay to the drawn rect (client pixels)
            const boxW = Math.max(1, Math.abs(rect.w));
            const boxH = Math.max(1, Math.abs(rect.h));
            const left = Math.min(rect.x, rect.x + rect.w);
            const top  = Math.min(rect.y, rect.y + rect.h);
            // Use uploaded file if present, else S3 logo URL
            const logoSrc = file ? URL.createObjectURL(file) : logoUrl;
            overlayImg.src = logoSrc;
            overlayImg.style.left = `${left}px`;
            overlayImg.style.top = `${top}px`;
            overlayImg.style.width = `${boxW}px`;
            overlayImg.style.height = `${boxH}px`;
            overlayImg.style.display = 'block';
            showMessage('‚úÖ Preview updated (not saved)', 'success');
          } catch (e) {
            console.warn('fast overlay preview failed', e);
          }
          return; // no persistence on Apply
        }

        // If saving a named design, persist version and preview
        if (autoSaveVersionName) {
          if (!email) { showMessage('Enter customer email first', 'error'); return; }
          const quoteId = window.__quoteId || 'QDEFAULT';
          const versionName = autoSaveVersionName;
          try {
            await fetch(`/api/quotes/${encodeURIComponent(quoteId)}/versions`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, versionId: versionName, name: versionName })
            });
            // If no zones scale available, prompt for known art width (inches) to derive pxPerIn
            let pxPerIn = window.__currentZonePxPerIn || null;
            let printerSpec = null;
            // No zones: server will compute pxPerIn via product image pixels vs SAGE imprint inches
            const designPayload = { email, logoRef: logoUrl, placement: { name:'print_area', px: { x1:n.x1, y1:n.y1, x2:n.x2, y2:n.y2 }, ...(pxPerIn ? { pxPerIn } : {}), ...(printerSpec ? { printerSpec } : {}) }, name: versionName };
            await fetch(`/api/quotes/${encodeURIComponent(quoteId)}/versions/${encodeURIComponent(versionName)}/designs/${encodeURIComponent(product.id)}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(designPayload)
            });
            const rRes = await fetch(`/api/quotes/${encodeURIComponent(quoteId)}/versions/${encodeURIComponent(versionName)}/previews/${encodeURIComponent(product.id)}/render`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
            });
            const rj = await rRes.json();
            if (!rRes.ok || !rj.ok) throw new Error('Preview render failed');
            // Update only this product: set dropdown to version and set its preview
            const card = document.querySelector(`.product-card[data-product-id="${product.id}"]`);
            const imageDiv = card?.querySelector('.product-image');
            const sel = card?.querySelector('.design-select');
            if (sel) { await window.repopulateVersionDropdown(product, email, versionName); }
            if (imageDiv && rj.previewUrl) imageDiv.style.backgroundImage = `url('${rj.previewUrl}')`;
            showMessage('‚úÖ Design saved (dropdown updated)', 'success');
          } catch (e) { console.error(e); showMessage('‚ùå Failed to save design: ' + e.message, 'error'); }
        }
      }

      async function saveBox() {
        const input = document.getElementById('bboxVersionName');
        const versionName = (input && input.value || '').trim();
        if (!versionName) {
          showMessage('Version name required', 'error');
          if (input) { input.style.borderColor = '#E53E3E'; try { input.focus(); } catch(_){} }
          return;
        }
        // Prevent duplicate version name for this product
        try {
          const email = (document.getElementById('customerEmail')?.value || '').trim();
          if (window.__quoteId && email) {
            const data = await fetch(`/api/quotes/${encodeURIComponent(window.__quoteId)}/products/${encodeURIComponent(product.id)}/versions?email=${encodeURIComponent(email)}`).then(r => r.json());
            const versions = Array.isArray(data?.versions) ? data.versions : [];
            if (versions.includes(versionName)) {
              showMessage('Version name already exists. Choose another.', 'error');
              input.style.borderColor = '#E53E3E'; try { input.focus(); input.select(); } catch(_){}
              return;
            }
          }
        } catch (_) {}
        await applyChanges(versionName);
        close();
      }
      
      async function fetchZonesAndScale() {
        try {
          window.__currentZoneSpec = null;
          window.__currentZonePxPerIn = null;
          // Try style from product.sku/id prefix
          const styleId = (product.sku || product.id || '').split(/[^A-Za-z0-9_-]/)[0];
          if (!styleId) return;
          const z = await fetch(`/api/zones/${encodeURIComponent(styleId)}`).then(r => r.json()).catch(() => null);
          const zone = z && z.data && Array.isArray(z.data.zones) ? (z.data.zones.find(zz => zz.name === 'print_area') || z.data.zones[0]) : null;
          if (!zone) return;
          window.__currentZoneSpec = zone;
          // Compute pxPerIn from zone.rectPx and physical
          const rw = Number(zone.rectPx?.w || 0), rh = Number(zone.rectPx?.h || 0);
          const pw = Number(zone.physical?.w_in || 0), ph = Number(zone.physical?.h_in || 0);
          const sx = pw > 0 ? rw / pw : 0; const sy = ph > 0 ? rh / ph : 0;
          const ppi = Math.max(1, sx || sy || 0, isFinite(sx) ? Math.min(sx, sy || sx) : sy);
          window.__currentZonePxPerIn = ppi;
        } catch (_) {}
      }

      async function open() {
        modal.style.display = 'flex';
        await fetchZonesAndScale();
        setTimeout(() => resizeCanvas(), 50);
      }
      function close() {
        modal.style.display = 'none';
        canvas.removeEventListener('mousedown', onDown);
        canvas.removeEventListener('mousemove', onMove);
        canvas.removeEventListener('mouseup',   onUp);
      }
      
      document.getElementById('bboxClose').onclick = close;
      document.getElementById('bboxClear').onclick = clearBox;
      const saveBtn = document.getElementById('bboxSave');
      saveBtn.onclick  = () => { saveBox().catch(err => { console.error(err); showMessage('Error: ' + err.message, 'error'); }); };
      document.getElementById('bboxApply').onclick = () => { applyChanges().catch(err => { console.error(err); showMessage('Error: ' + err.message, 'error'); }); };
      // Disable Save until a box is drawn and version entered
      function refreshSaveDisabled(){
        const input = document.getElementById('bboxVersionName');
        const hasName = (input && input.value.trim().length > 0);
        const hasBox = !!rect && Math.abs(rect.w) > 2 && Math.abs(rect.h) > 2;
        saveBtn.disabled = !(hasName && hasBox);
        saveBtn.style.opacity = saveBtn.disabled ? '.6' : '1';
        saveBtn.style.cursor = saveBtn.disabled ? 'not-allowed' : 'pointer';
      }
      refreshSaveDisabled();
      document.getElementById('bboxVersionName')?.addEventListener('input', refreshSaveDisabled);
      const _onDown = onDown; const _onMove = onMove; const _onUp = onUp; // preserve
      onDown = function(ev){ _onDown(ev); refreshSaveDisabled(); };
      onMove = function(ev){ _onMove(ev); refreshSaveDisabled(); };
      onUp   = function(ev){ _onUp(ev); refreshSaveDisabled(); };

      // Grid toggle
      let __gridOn = true;
      function setGrid(on){
        __gridOn = !!on;
        wrap.style.background = __gridOn ? 'repeating-conic-gradient(#f7fafc 0% 25%, transparent 0% 50%) 50% / 20px 20px' : 'none';
        const gb = document.getElementById('bboxGrid');
        if (gb) gb.textContent = __gridOn ? 'Grid: On' : 'Grid: Off';
      }
      setGrid(true);
      const gridBtn = document.getElementById('bboxGrid');
      if (gridBtn) gridBtn.onclick = () => setGrid(!__gridOn);
      // Show selected filename next to Upload button
      const fileInputUI = document.getElementById('logoFile');
      const fileNameUI = document.getElementById('logoFileName');
      if (fileInputUI) {
        fileInputUI.addEventListener('change', () => {
          const name = fileInputUI.files && fileInputUI.files[0] ? fileInputUI.files[0].name : '';
          if (fileNameUI) fileNameUI.textContent = name ? `Selected: ${name}` : '';
        });
      }
      // Fallback inline handler in case onclick binding is stripped by extensions
      window.__bboxApply = (vn) => { try { applyChanges(vn); } catch (e) { console.error(e); } };
      document.getElementById('bboxApply').setAttribute('onclick', 'window.__bboxApply && window.__bboxApply()');
      if (forced) {
        // In forced mode, Save button acts like Apply (save boxes + generate mockup) and move to next
        document.getElementById('bboxSave').textContent = 'Save Position';
        document.getElementById('bboxSave').onclick = () => { applyChanges().catch(err => { console.error(err); showMessage('Error: ' + err.message, 'error'); }); close(); if (typeof onDone === 'function') onDone(); };
      }
      imgEl.onload = resizeCanvas;
      window.addEventListener('resize', resizeCanvas);
      
      canvas.addEventListener('mousedown', onDown);
      canvas.addEventListener('mousemove', onMove);
      canvas.addEventListener('mouseup',   onUp);
      
      open();
    }

    async function generateMockup(productId, btnEl) {
      console.log('Generating mockup for product:', productId);
      const email = (document.getElementById('customerEmail').value || '').trim();
      if (!email) { showMessage('Enter a customer email first', 'error'); return; }

      // Let the server choose the default logo for this email.
      const button = btnEl || document.querySelector(`.product-card[data-product-id="${productId}"] .btn`);
      const originalText = button ? button.textContent : '';
      if (button) { button.disabled = true; button.textContent = '‚è≥ Generating...'; }

      try {
        showMessage('Generating mockup and uploading to S3...', 'success');
        const response = await fetch(`/api/products/${encodeURIComponent(productId)}/mockup`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
        });
        const result = await response.json();
        if (!response.ok || !result.ok) { throw new Error(result.error || 'Mockup generation failed'); }
        showMessage('‚úÖ Mockup generated and uploaded to S3!', 'success');
        // Refresh only this product's image instead of the entire catalog
        const list = await fetch(`/api/products?customerEmail=${encodeURIComponent(email)}`).then(r => r.json());
        const updated = Array.isArray(list) ? list.find(p => p.id === productId) : null;
        if (updated) {
          const nextUrl = updated.previewImageUrl || updated.baseImageUrl || '';
          const bust = nextUrl ? `${nextUrl}${nextUrl.includes('?') ? '&' : '?'}cb=${Date.now()}` : nextUrl;
          await updateProductCardImage(productId, bust, email);
        }
      } catch (error) {
        console.error('Mockup generation error:', error);
        showMessage(`‚ùå Mockup generation failed: ${error.message}`, 'error');
      } finally {
        if (button) { button.disabled = false; button.textContent = originalText; }
      }
    }
    function adjustQuantity(productId, delta) {
      const input = document.getElementById(`qty-${productId}`);
      const newValue = Math.max(0, parseInt(input.value || '0') + delta);
      input.value = newValue;
      updateProductPricing(productId);
    }

    // Calculate unit price locally
    function calculateUnitPrice(product, quantity) {
      const qty = parseInt(quantity) || 0;
      if (qty === 0) return product.currentPrice || 0;
      
      const tier = product.pricing.find(p => 
        qty >= p.minQty && (p.maxQty === null || qty <= p.maxQty)
      );
      return tier ? tier.price : product.pricing[0].price;
    }

    // Update product pricing display
    function updateProductPricing(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const quantity = parseInt(document.getElementById(`qty-${productId}`).value || '0');
      const priceEl = document.getElementById(`price-${product.id}`);
      const savingsEl = document.getElementById(`savings-${product.id}`);

      if (quantity === 0) {
        priceEl.textContent = `Starting at $${(product.currentPrice || 0).toFixed(2)}`;
        savingsEl.style.display = 'none';
        return;
      }

      const unitPrice = calculateUnitPrice(product, quantity);
      const totalPrice = unitPrice * quantity;
      priceEl.textContent = `$${totalPrice.toFixed(2)} ($${unitPrice.toFixed(2)} each)`;

      // Show savings
      const basePrice = product.currentPrice || product.pricing[0].price;
      const savings = quantity > 1 ? (basePrice - unitPrice) * quantity : 0;
      if (savings > 0) {
        savingsEl.textContent = `Save $${savings.toFixed(2)}`;
        savingsEl.style.display = 'inline-block';
      } else {
        savingsEl.style.display = 'none';
      }

      // Highlight active tier
      const card = document.getElementById(`qty-${productId}`).closest('.product-card');
      if (card) {
        card.querySelectorAll('.pricing-tier').forEach(tierEl => {
          const range = tierEl.dataset.range;
          const tier = product.pricing.find(p => {
            const tierRange = p.maxQty ? `${p.minQty}-${p.maxQty}` : `${p.minQty}+`;
            return range === tierRange;
          });
          const isActive = tier && quantity >= tier.minQty && (tier.maxQty === null || quantity <= tier.maxQty);
          tierEl.classList.toggle('active', isActive);
        });
      }
      
      // Update quote totals
      updateQuote();
    }

    // Update quote
    function updateQuote() {
      quote = [];
      products.forEach(product => {
        const quantity = parseInt(document.getElementById(`qty-${product.id}`).value || '0');
        if (quantity > 0) {
          quote.push({
            productId: product.id,
            product: product,
            quantity: quantity,
            unitPrice: calculateUnitPrice(product, quantity),
            totalPrice: calculateUnitPrice(product, quantity) * quantity
          });
        }
      });
      updateQuoteDisplay();
      calculateTax();
    }

    // Update quote display
    function updateQuoteDisplay() {
      const container = document.getElementById('quoteItems');
      
      if (quote.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No items selected</h3>
            <p>Adjust quantities above to build your quote</p>
          </div>
        `;
        return;
      }

      const subtotal = quote.reduce((sum, item) => sum + item.totalPrice, 0);
      
      const itemsHtml = quote.map(item => `
        <div class="quote-item">
          <div class="item-info">
            <div class="item-name">${item.product.name}</div>
            <div class="item-details">Qty ${item.quantity} √ó $${item.unitPrice.toFixed(2)} = $${item.totalPrice.toFixed(2)}</div>
          </div>
          <button class="remove-btn" onclick="removeFromQuote('${String(item.productId).replace(/'/g, "\\'")}')">Remove</button>
        </div>
      `).join('');

      container.innerHTML = `
        ${itemsHtml}
        <div class="quote-totals">
          <div class="total-line">
            <span>Subtotal</span>
            <span>$${subtotal.toFixed(2)}</span>
          </div>
          <div class="total-line">
            <span>Shipping</span>
            <span>Calculated at checkout</span>
          </div>
          <div class="total-line">
            <span>Tax</span>
            <span>${taxAmount > 0 ? '$' + taxAmount.toFixed(2) + ' (estimate)' : 'Calculated at checkout'}</span>
          </div>
          <div class="grand-total">
            <span>Quote Total</span>
            <span>$${(subtotal + taxAmount).toFixed(2)}${taxAmount === 0 ? ' + tax & shipping' : ' + shipping'}</span>
          </div>
        </div>
      `;
    }

    // Copy quote summary to clipboard
    async function copyQuoteSummary() {
      const items = quote.map(it => ({
        productId: it.productId,
        name: it.product.name,
        quantity: it.quantity,
        unitPrice: it.unitPrice,
        totalPrice: it.totalPrice,
        version: (document.querySelector(`.design-select[data-id="${it.productId}"]`)?.value || 'Default')
      }));
      const summary = {
        quoteId: window.__quoteId || '',
        email: (document.getElementById('customerEmail')?.value || '').trim(),
        items
      };
      const text = items.length
        ? items.map(i => `${i.name} (${i.productId}) ‚Äî Qty ${i.quantity} ‚Äî ${i.version} ‚Äî $${i.totalPrice.toFixed(2)}`).join('\n')
        : 'No items.';
      try {
        await navigator.clipboard.writeText(text);
        showMessage('‚úÖ Quote summary copied to clipboard', 'success');
      } catch (_) {
        showMessage('‚ùå Could not copy summary', 'error');
      }
    }

    // Remove from quote
    function removeFromQuote(productId) {
      document.getElementById(`qty-${productId}`).value = '0';
      updateProductPricing(productId);
      updateQuote();
    }

    // Tax calculation
    async function calculateTax() {
      const zip = document.getElementById('taxZip').value.trim();
      if (!zip || quote.length === 0) {
        taxAmount = 0;
        updateQuoteDisplay();
        return;
      }

      try {
        const response = await fetch('/api/calculate-tax', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            zip: zip,
            items: quote.map(item => ({
              productId: item.productId,
              quantity: item.quantity,
              unitPrice: item.unitPrice
            }))
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          taxAmount = data.taxAmount || 0;
        } else {
          taxAmount = 0;
        }
      } catch (error) {
        console.error('Tax calculation failed:', error);
        taxAmount = 0;
      }
      
      updateQuoteDisplay();
    }

    // Proceed to checkout
    async function proceedToCheckout() {
      if (quote.length === 0) {
        showMessage('Please add items to your quote first', 'error');
        return;
      }

      const btn = document.getElementById('checkoutBtn');
      btn.disabled = true;
      btn.textContent = 'Creating checkout session...';

      try {
        const customerEmail = document.getElementById('customerEmail').value.trim();
        
        const payload = {
          customerInfo: { 
            name: '', 
            email: customerEmail || '', 
            company: '', 
            phone: '' 
          },
          products: quote.map(item => ({ 
            productId: item.productId, 
            quantity: item.quantity,
            versionId: (document.querySelector(`.design-select[data-id="${item.productId}"]`)?.value || '')
          })),
          quoteId: window.__quoteId || '',
          versionId: window.__versionId || '',
          shippingAddress: { 
            line1: 'TBD', city: 'TBD', state: 'TBD', 
            postal_code: 'TBD', country: 'US' 
          },
          billingAddress: { 
            line1: 'TBD', city: 'TBD', state: 'TBD', 
            postal_code: 'TBD', country: 'US' 
          }
        };

        const response = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();

        if (data.url) {
          showMessage('Redirecting to secure checkout...', 'success');
          window.location = data.url;
        } else {
          showMessage('Checkout failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showMessage('Checkout failed: ' + error.message, 'error');
        console.error('Checkout error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üöÄ Get Final Quote & Checkout';
      }
    }

    // Helper to safely update a product card image with fallbacks
    async function updateProductCardImage(productId, candidateUrl, email) {
      const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
      const imageDiv = card?.querySelector('.product-image');
      if (!imageDiv) return;
      const trySet = (url) => { if (url) imageDiv.style.backgroundImage = `url('${url}')`; };
      // Test candidate first
      if (candidateUrl) {
        const test = new Image();
        const ok = await new Promise((resolve) => { test.onload = () => resolve(true); test.onerror = () => resolve(false); test.src = candidateUrl; });
        if (ok) { trySet(candidateUrl); return; }
      }
      // Fallback: fetch legacy preview for this product
      try {
        const list = await fetch(`/api/products?customerEmail=${encodeURIComponent(email || '')}`, { cache: 'no-store' }).then(r => r.json());
        const p = Array.isArray(list) ? list.find(x => x.id === productId) : null;
        const url = p?.previewImageUrl || p?.baseImageUrl || '';
        if (url) trySet(url);
      } catch (e) { /* ignore */ }
    }
  </script>
</body>
</html>